# Auto-Release Workflow Setup

This repository uses a controlled release workflow. The workflow automatically creates releases when pull requests are merged to the release branch.

## üîê Required GitHub Secret

The workflow requires a Personal Access Token (PAT) with workflow permissions to push version updates back to the repository.

### Setting up PAT_TOKEN

1. **Generate a Personal Access Token:**
   - Go to GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)
   - Click "Generate new token (classic)"
   - Name: `hash-zig Auto-Release`
   - Expiration: Choose your preference (recommended: 90 days or 1 year)
   - Select scopes:
     - ‚úÖ `repo` (Full control of private repositories)
     - ‚úÖ `workflow` (Update GitHub Action workflows)
   - Click "Generate token"
   - **Copy the token immediately** (you won't be able to see it again)

2. **Add token to repository secrets:**
   - Go to repository Settings ‚Üí Secrets and variables ‚Üí Actions
   - Click "New repository secret"
   - Name: `PAT_TOKEN`
   - Value: Paste the token you copied
   - Click "Add secret"

## üöÄ How It Works

### Automatic Releases

The workflow automatically creates a release when:

1. **Pull requests are merged** to the release branch
2. **Commit messages** containing keywords:
   - `[release]` - Creates a patch release
   - `[patch]` or `fix:` - Patch version bump (0.0.x)
   - `[minor]` or `feat:` - Minor version bump (0.x.0)
   - `[major]` or `BREAKING CHANGE:` - Major version bump (x.0.0)
3. **Manual workflow dispatch** (choose version bump type)

### Skip Releases

To skip a release, include in your commit message:
- `[skip release]`
- `[no release]`
- `[skip ci]`

### Version Calculation

Follows semantic versioning:
- **Major** (x.0.0): Breaking changes
- **Minor** (0.x.0): New features (backwards compatible)
- **Patch** (0.0.x): Bug fixes

### What Gets Released

Each release includes:

1. **Git Tag**: Created with version number (e.g., `v0.2.0`)
2. **Version Update**: `build.zig.zon` version is updated automatically
3. **Binary Artifacts**: Built for multiple platforms:
   - Linux (x86_64, aarch64)
   - macOS (x86_64, aarch64)
   - Windows (x86_64)
4. **GitHub Release**: With:
   - Changelog (commits since last release)
   - Release notes
   - Binary artifacts
   - Installation instructions

## üìù Example Commit Messages

```bash
# Create a patch release (0.1.0 ‚Üí 0.1.1)
git commit -m "fix: resolve memory leak in signature verification [patch]"

# Create a minor release (0.1.0 ‚Üí 0.2.0)
git commit -m "feat: add support for different hash functions [minor]"

# Create a major release (0.1.0 ‚Üí 1.0.0)
git commit -m "feat!: new API with breaking changes [major]"

# Skip release
git commit -m "docs: update README [skip release]"
```

## üîÑ Manual Release

You can manually trigger a release:

1. Go to Actions ‚Üí Auto Release on Release Branch
2. Click "Run workflow"
3. Select branch: `release`
4. Choose version bump: `major`, `minor`, or `patch`
5. Click "Run workflow"

## üõ†Ô∏è Workflow Jobs

1. **determine-release**: Checks if release should be created and calculates version
2. **create-tag**: Updates version in build.zig.zon, commits, and creates git tag
3. **build-release**: Builds artifacts for all platforms in parallel
4. **create-github-release**: Creates GitHub release with artifacts and notes

## üì¶ Using Releases

To use a specific version in your project:

```zig
// build.zig.zon
.{
    .name = "my_project",
    .version = "0.1.0",
    .dependencies = .{
        .@"hash-zig" = .{
            .url = "https://github.com/ch4r10t33r/hash-zig/archive/v0.2.0.tar.gz",
            .hash = "1220...", // Generated by zig build
        },
    },
}
```

## üîç Troubleshooting

### Workflow fails on "Commit and push version update"

**Problem**: Missing or invalid PAT_TOKEN

**Solution**: 
1. Verify PAT_TOKEN is set in repository secrets
2. Ensure token has `repo` and `workflow` scopes
3. Check token hasn't expired

### Release not triggered on merge

**Problem**: Commit message contains skip keywords

**Solution**: Check commit message doesn't contain `[skip release]`, `[no release]`, or `[skip ci]`

### Build fails for specific platform

**Problem**: Platform-specific build issue

**Solution**: The workflow uses `fail-fast: false`, so other platforms will still build. Check the failed job logs for specific errors.

## üìä Monitoring

View release history:
- **Releases**: https://github.com/ch4r10t33r/hash-zig/releases
- **Workflow runs**: https://github.com/ch4r10t33r/hash-zig/actions/workflows/auto-release.yml
- **Tags**: https://github.com/ch4r10t33r/hash-zig/tags

## üÜö Current Workflow Features

| Feature | Current (auto-release.yml) |
|---------|---------------------------|
| Trigger | Pull request merge to release branch |
| Version calculation | Semantic + manual override |
| Release notes | Comprehensive with examples |
| Manual trigger | With version choice |
| Skip releases | Yes (`[skip release]`) |
| Changelog | Auto-generated from commits |
| Platform builds | Multi-platform binaries |

## üîó Related

- Based on: [zigeth auto-release workflow](https://github.com/ch4r10t33r/zigeth/.github/workflows/auto-release.yml)
- See also: `.github/workflows/ci.yml` for continuous integration

