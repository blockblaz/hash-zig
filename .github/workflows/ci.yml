on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:

# Cancel in-progress runs for PRs
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

name: CI

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Zig
      uses: mlugg/setup-zig@v2.0.5
      with:
        version: 0.14.1

    - name: Cache Zig packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/zig
        key: ${{ runner.os }}-zig-packages-${{ hashFiles('build.zig.zon') }}
        restore-keys: |
          ${{ runner.os }}-zig-packages-

    - name: Fetch Zig dependencies with retry
      run: |
        max_attempts=5
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if zig build --fetch; then
            echo "Successfully fetched dependencies on attempt $attempt"
            exit 0
          fi
          echo "Attempt $attempt/$max_attempts failed, retrying in 5 seconds..."
          sleep 5
          attempt=$((attempt + 1))
        done
        echo "Failed to fetch dependencies after $max_attempts attempts"
        exit 1

    - name: Lint
      run: zig fmt --check .

  test:
    needs: lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Zig
      uses: mlugg/setup-zig@v2.0.5
      with:
        version: 0.14.1

    - name: Cache Zig packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/zig
        key: ${{ runner.os }}-zig-packages-${{ hashFiles('build.zig.zon') }}
        restore-keys: |
          ${{ runner.os }}-zig-packages-

    - name: Fetch Zig dependencies with retry
      run: |
        max_attempts=5
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if zig build --fetch; then
            echo "Successfully fetched dependencies on attempt $attempt"
            exit 0
          fi
          echo "Attempt $attempt/$max_attempts failed, retrying in 5 seconds..."
          sleep 5
          attempt=$((attempt + 1))
        done
        echo "Failed to fetch dependencies after $max_attempts attempts"
        exit 1

    - name: Build library
      run: zig build install -Doptimize=ReleaseFast -Ddebug-logs=false

    - name: Run core unit tests
      run: zig build test --summary all

    - name: Run extended tests
      run: zig build test-extended --summary all

    - name: Run lifetime tests
      run: zig build test-lifetimes --summary all

  cross-language:
    name: Cross-Language Compatibility (SSZ)
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Zig
      uses: mlugg/setup-zig@v2.0.5
      with:
        version: 0.14.1

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: nightly

    - name: Cache Zig packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/zig
        key: ${{ runner.os }}-zig-packages-${{ hashFiles('build.zig.zon') }}
        restore-keys: |
          ${{ runner.os }}-zig-packages-

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "benchmark/rust_benchmark -> target"
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Fetch Zig dependencies with retry
      run: |
        max_attempts=5
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if zig build --fetch; then
            echo "Successfully fetched dependencies on attempt $attempt"
            exit 0
          fi
          echo "Attempt $attempt/$max_attempts failed, retrying in 5 seconds..."
          sleep 5
          attempt=$((attempt + 1))
        done
        echo "Failed to fetch dependencies after $max_attempts attempts"
        exit 1

    - name: Build library
      run: zig build install -Doptimize=ReleaseFast -Ddebug-logs=false

    - name: Run cross-language compatibility suite
      run: python3 benchmark/benchmark.py --lifetime "2^8,2^32"

    - name: Test pre-generated keys
      run: python3 benchmark/inspect_pregenerated_keys.py

  build:
    name: Build (${{ matrix.os }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Zig
      uses: mlugg/setup-zig@v2.0.5
      with:
        version: 0.14.1

    - name: Cache Zig packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/zig
        key: ${{ runner.os }}-zig-packages-${{ hashFiles('build.zig.zon') }}
        restore-keys: |
          ${{ runner.os }}-zig-packages-

    - name: Fetch Zig dependencies with retry
      shell: bash
      run: |
        max_attempts=5
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if zig build --fetch; then
            echo "Successfully fetched dependencies on attempt $attempt"
            exit 0
          fi
          echo "Attempt $attempt/$max_attempts failed, retrying in 5 seconds..."
          sleep 5
          attempt=$((attempt + 1))
        done
        echo "Failed to fetch dependencies after $max_attempts attempts"
        exit 1

    - name: Build
      run: zig build
